name: CI

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:

env:
  QUARKUS_CONTAINER_IMAGE_USERNAME: ${{ secrets.DOCKER_HUB_LOGIN }}
  QUARKUS_CONTAINER_IMAGE_PASSWORD: ${{ secrets.DOCKER_HUB_PWD }}
  GITHUB_REF: ${{ github.ref }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-repo
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin
          cache: maven
        
      - uses: codfish/semantic-release-action@v3
        with:
          branches: |
            [
              'main',
              { 
                name: 'dev',
                prerelease: 'dev'
              }
            ]
          plugins: |
            [
              [
                "@semantic-release/commit-analyzer",
                {
                  "preset": "angular"
                }
              ],
              "@semantic-release/release-notes-generator",
              [
                "@semantic-release/docker",
                {
                  "image": "${{ env.QUARKUS_CONTAINER_IMAGE_USERNAME }}/my-app:${{ github.ref }}",
                  "tag": "${{ github.ref }}"
                }
              ]
            ]
        
      - name: Build
        run: |
          ./mvnw package -B -Dquarkus.container-image.tag=${{ github.ref }}
          docker image ls
